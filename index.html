<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Naši klienti</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .nav-link.active {
            background-color: #eef2ff; /* indigo-50 */
            color: #4338ca; /* indigo-700 */
        }
        #filter-panel { transition: max-height 0.3s ease-in-out, margin-bottom 0.3s ease-in-out; }
        .status-icon-group:hover .status-icon-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        #toast-notification {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="text-slate-800">

    <div class="flex flex-col h-screen">
        <!-- Header -->
        <header class="bg-white/95 backdrop-blur-lg border-b border-slate-200 sticky top-0 z-30">
            <div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center gap-3">
                         <div style="background-color: #34A853;" class="text-white p-2 rounded-lg">
                            <i data-lucide="users-round"></i>
                        </div>
                        <h1 class="text-xl font-extrabold text-slate-900 hidden sm:block">Naši klienti</h1>
                    </div>
                    <nav class="flex items-center gap-2 bg-slate-100 p-1 rounded-full">
                        <button data-view="dashboard" class="nav-link active font-semibold text-slate-700 px-4 py-1.5 rounded-full text-sm">Přehled</button>
                        <button data-view="clients" class="nav-link font-semibold text-slate-500 hover:text-slate-800 px-4 py-1.5 rounded-full text-sm">Klienti</button>
                    </nav>
                    <div class="flex items-center gap-4">
                        <img src="https://iili.io/KnfRVlp.png" alt="Logo firmy" class="h-8 w-auto">
                        <button id="reloadDataBtn" title="Aktualizovat data" class="p-2 rounded-full text-slate-500 hover:bg-slate-100 hover:text-indigo-600 transition-colors disabled:opacity-50 disabled:cursor-wait">
                            <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">
            <div id="app-content" class="max-w-screen-xl mx-auto p-4 sm:p-6 lg:p-8">
                <!-- Dashboard View -->
                <div id="dashboard-view">
                     <div class="mb-8">
                        <h1 class="text-3xl font-bold text-slate-900">Vítejte zpět!</h1>
                        <p class="text-slate-500 mt-1">Zde je rychlý přehled vašeho klientského portfolia.</p>
                    </div>
                     <div id="dashboard-content" class="opacity-0 transition-opacity duration-500">
                        <div id="stats-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"></div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm">
                                <h3 class="text-lg font-semibold text-slate-800 mb-4">Poslední přidaní klienti</h3>
                                <div id="recent-clients-container" class="space-y-3">
                                    <!-- Recent clients list will go here -->
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-2xl shadow-sm flex flex-col">
                                <h3 class="text-lg font-semibold text-slate-800 mb-4">Top 5 kategorií</h3>
                                <div class="relative flex-1"><canvas id="topCategoriesChart"></canvas></div>
                            </div>
                        </div>
                     </div>
                </div>
                <!-- Clients View -->
                <div id="clients-view" class="hidden">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8">
                        <div>
                            <h1 class="text-3xl font-bold text-slate-900">Seznam klientů</h1>
                            <p class="text-slate-500 mt-1">Prohlížejte a filtrujte své portfolio.</p>
                        </div>
                        <div class="flex items-center gap-2 mt-4 sm:mt-0">
                            <button id="toggle-filters-btn" class="flex items-center gap-2 py-2 px-4 bg-white border border-slate-300 rounded-lg text-slate-700 font-semibold hover:bg-slate-50 transition">
                                <i data-lucide="filter" class="w-4 h-4"></i> Filtry <span id="filter-count" class="hidden bg-indigo-600 text-white text-xs w-5 h-5 rounded-full items-center justify-center ml-2"></span>
                            </button>
                        </div>
                    </div>
                    <!-- Filter Panel -->
                    <div id="filter-panel" class="bg-white rounded-2xl shadow-sm max-h-0 overflow-hidden">
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="searchQuery" class="block text-sm font-medium text-slate-600 mb-2">Vyhledat firmu</label>
                                    <input type="text" id="searchQuery" placeholder="Název firmy..." class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                                </div>
                                <div>
                                    <label for="categoryFilter" class="block text-sm font-medium text-slate-600 mb-2">Kategorie</label>
                                    <select id="categoryFilter" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition"><option value="all">Všechny kategorie</option></select>
                                </div>
                                <div class="md:col-span-2">
                                    <h3 class="block text-sm font-medium text-slate-600 mb-3">Služby</h3>
                                    <div id="servicesFilter" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-y-3 gap-x-6"></div>
                                </div>
                            </div>
                        </div>
                        <div class="px-6 pb-4 pt-4 border-t border-slate-200 flex justify-end">
                            <button id="resetFiltersBtn" class="flex items-center justify-center gap-2 py-2 px-4 bg-slate-100 text-slate-700 rounded-lg font-semibold hover:bg-slate-200 transition">
                                <i data-lucide="rotate-cw" class="w-4 h-4"></i> Resetovat filtry
                            </button>
                        </div>
                    </div>
                    
                    <div id="clients-container" class="space-y-3"></div>
                    <div id="empty-state" class="hidden text-center py-20"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification" class="fixed bottom-5 right-5 bg-green-500 text-white py-3 px-5 rounded-lg shadow-lg flex items-center gap-3 opacity-0 translate-y-4 z-50">
        <i data-lucide="check-circle" class="w-5 h-5"></i>
        <span id="toast-message" class="font-semibold"></span>
    </div>

    <!-- Skeleton Loader Structure -->
    <div id="skeleton-loader" class="max-w-screen-xl mx-auto p-4 sm:p-6 lg:p-8"></div>
    
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        // --- CONFIG ---
        const CLIENTS_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQKN-JqGkH2b0dqI7-gHuDggTdi76W-7g-Q4eWlN2RMHjzMpYeG-PTO0r_GiAhm-ZnAxQeuN6nAmNt8/pub?gid=0&single=true&output=csv';
        const STATS_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQKN-JqGkH2b0dqI7-gHuDggTdi76W-7g-Q4eWlN2RMHjzMpYeG-PTO0r_GiAhm-ZnAxQeuN6nAmNt8/pub?gid=1290897837&single=true&output=csv';

        const FETCH_TIMEOUT = 15000;
        const sectionMap = {
            gsv: { title: 'Google Street View', keys: ['linktour', 'linkdrone'] },
            gmf: { title: 'Google Moje Firma', keys: ['hasoptimization', 'hasmanagement', 'linkproducts', 'linkbanners'] },
            other: { title: 'Další služby', keys: ['linkapp', 'linknfc'] }
        };
        const servicesMap = {
            'linktour': { name: 'Virtuální prohlídka', icon: 'camera' }, 'linkdrone': { name: 'Dron', icon: 'drone' }, 'hasoptimization': { name: 'Optimalizace', icon: 'trending-up' }, 'hasmanagement': { name: 'Správa', icon: 'user-cog' }, 'linkproducts': { name: 'Produkty', icon: 'shopping-cart' }, 'linkbanners': { name: 'Příspěvky', icon: 'image' }, 'linkapp': { name: 'Aplikace', icon: 'smartphone' }, 'linknfc': { name: 'NFC', icon: 'wifi' }
        };
        const otherLinksMap = {
            'gmbsearch': { name: 'Profil ve Vyhledávači', icon: 'search' },
            'gmbmaps': { name: 'Profil v Mapách', icon: 'map' },
            'linkstatisticgmf': { name: 'Statistiky GMF', icon: 'store' },
            'linkstatisticvirtual': { name: 'Statistiky Prohlídek', icon: 'route' },
        };
        // --- STATE ---
        let clientsData = [], statsData = {}, filteredClients = [];
        // --- ELEMENTS ---
        const el = {
            navLinks: document.querySelectorAll('.nav-link'), views: { dashboard: document.getElementById('dashboard-view'), clients: document.getElementById('clients-view') }, dashboardContent: document.getElementById('dashboard-content'), statsContainer: document.getElementById('stats-container'), clientsContainer: document.getElementById('clients-container'), emptyState: document.getElementById('empty-state'), skeletonLoader: document.getElementById('skeleton-loader'), reloadDataBtn: document.getElementById('reloadDataBtn'), toggleFiltersBtn: document.getElementById('toggle-filters-btn'), filterPanel: document.getElementById('filter-panel'), filterCount: document.getElementById('filter-count'), searchQuery: document.getElementById('searchQuery'), categoryFilter: document.getElementById('categoryFilter'), locationFilter: document.getElementById('locationFilter'), servicesFilterContainer: document.getElementById('servicesFilter'),
            recentClientsContainer: document.getElementById('recent-clients-container'),
            resetFiltersBtn: document.getElementById('resetFiltersBtn'),
            toast: document.getElementById('toast-notification'),
            toastMessage: document.getElementById('toast-message'),
        };
        let topCategoriesChart = null;

        // --- HELPERS ---
        const debounce = (func, delay) => {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        };

        // --- FETCH & PARSE ---
        const parseCSVLine = (line) => {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (inQuotes && line[i+1] === '"') {
                        current += '"'; i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current); current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        };

        const fetchAndParseSheetData = async (url, isStats = false, forceRefresh = false) => {
             if (!url || url.startsWith('SEM_VLOZTE')) { return isStats ? {} : []; }
            let fetchUrl = url;
            if (forceRefresh) {
                fetchUrl += (url.includes('?') ? '&' : '?') + '_=' + new Date().getTime();
            }
            try {
                const response = await fetch(fetchUrl, { signal: AbortSignal.timeout(FETCH_TIMEOUT) });
                if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
                const csvText = await response.text();
                const lines = csvText.trim().split(/\r?\n/);
                if (lines.length < 2) return isStats ? {} : [];
                const rawHeaders = parseCSVLine(lines[0]).map(h => h.trim().toLowerCase().replace(/\s+/g, ''));
                
                const data = lines.slice(1).map(line => {
                    const values = parseCSVLine(line);
                    const obj = {};
                    rawHeaders.forEach((h, i) => obj[h] = (values[i] || '').trim());
                    return obj;
                }).filter(Boolean);

                if (isStats) {
                    return data.reduce((acc, item) => {
                        if (item.klic && item.hodnota) acc[item.klic] = parseInt(item.hodnota, 10) || 0;
                        return acc;
                    }, {});
                }
                if (!['id', 'name', 'category'].every(h => rawHeaders.includes(h))) throw new Error(`Chybí povinné sloupce (id, name, category).`);
                
                return data.map(clientObj => {
                    const id = parseInt(clientObj.id, 10); if (isNaN(id)) return null;
                    const clientData = { id, name: clientObj.name || 'N/A', category: clientObj.category || 'N/A', isNew: (clientObj.isnew || '').toLowerCase() === 'true' };
                    Object.assign(clientData, clientObj);
                    return clientData;
                }).filter(Boolean);

            } catch (error) { console.error(`Fetch error for ${url}:`, error); return isStats ? {} : null; }
        };

        // --- RENDER ---
        const createStatusIcon = (client, key, name, icon) => {
            const value = client[key];
            const isActive = value && value.toLowerCase() !== 'false' && value.trim() !== '';
            
            let linkValue = value;
            if (isActive && linkValue && !linkValue.startsWith('http')) {
                linkValue = 'https://' + linkValue;
            }
            const isClickable = isActive && linkValue;

            const iconEl = `<div class="relative status-icon-group"><i data-lucide="${icon}" class="w-5 h-5 ${isActive ? 'text-slate-600' : 'text-slate-400'}"></i><div class="absolute -top-1 -right-1 w-2 h-2 rounded-full border border-white ${isActive ? 'bg-green-500' : 'bg-red-500'}"></div><div class="status-icon-tooltip absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max bg-slate-800 text-white text-xs rounded py-1 px-2 shadow-lg opacity-0 visibility-hidden transition-all duration-200 transform-gpu translate-y-1 z-10">${name}</div></div>`;
            
            if (isClickable) {
                return `<a href="${linkValue}" target="_blank" class="transition-transform hover:scale-110">${iconEl}</a>`;
            } else {
                return `<div class="cursor-default">${iconEl}</div>`;
            }
        };

        const createClientCard = (client) => {
            const gsvIcons = sectionMap.gsv.keys.map(key => createStatusIcon(client, key, servicesMap[key].name, servicesMap[key].icon)).join('');
            const gmfIcons = sectionMap.gmf.keys.map(key => createStatusIcon(client, key, servicesMap[key].name, servicesMap[key].icon)).join('');
            const otherIcons = sectionMap.other.keys.map(key => createStatusIcon(client, key, servicesMap[key].name, servicesMap[key].icon)).join('');
            const linkIcons = Object.entries(otherLinksMap).map(([key, link]) => createStatusIcon(client, key, link.name, link.icon)).join('');

            return `<div class="bg-white p-4 rounded-xl shadow-sm flex items-center gap-4"><div class="flex-1"><div class="flex items-center gap-2"><h3 class="text-lg font-bold text-slate-900">${client.name}</h3>${client.isNew ? '<span class="text-xs font-bold text-green-700 bg-green-100 px-2 py-1 rounded-full">NOVÝ</span>' : ''}</div><p class="text-sm text-slate-500 font-medium">${client.category}</p></div><div class="flex items-center gap-4"><div class="flex items-center gap-3">${gsvIcons}</div><div class="w-px h-6 bg-slate-200"></div><div class="flex items-center gap-3">${gmfIcons}</div><div class="w-px h-6 bg-slate-200"></div><div class="flex items-center gap-3">${otherIcons}</div><div class="w-px h-6 bg-slate-200"></div><div class="flex items-center gap-3">${linkIcons}</div></div></div>`;
        };
        
        const renderClients = () => {
            try {
                if (filteredClients.length > 0) {
                    el.clientsContainer.innerHTML = filteredClients.map(createClientCard).join('');
                    el.emptyState.classList.add('hidden');
                    el.clientsContainer.classList.remove('hidden');
                } else {
                    el.clientsContainer.classList.add('hidden');
                    el.emptyState.innerHTML = `<div class="inline-block bg-white p-5 rounded-full shadow-sm"><i data-lucide="search-x" class="w-12 h-12 text-slate-400"></i></div><h3 class="mt-6 text-xl font-semibold">Nic nenalezeno</h3><p class="mt-2 text-slate-500">Zkuste upravit filtry.</p>`;
                    el.emptyState.classList.remove('hidden');
                }
                lucide.createIcons();
            } catch (error) {
                console.error("Chyba při vykreslování klientů:", error);
                el.clientsContainer.innerHTML = '';
                el.emptyState.innerHTML = `<div class="inline-block bg-red-100 p-5 rounded-full shadow-sm"><i data-lucide="alert-triangle" class="w-12 h-12 text-red-500"></i></div><h3 class="mt-6 text-xl font-semibold">Chyba při zobrazení</h3><p class="mt-2 text-slate-500">Nastala chyba při vykreslování seznamu klientů.</p><p class="mt-1 text-xs text-slate-400">Chyba: ${error.message}</p>`;
                el.emptyState.classList.remove('hidden');
                lucide.createIcons();
            }
        };
        
        const resetFilters = () => {
            el.searchQuery.value = '';
            el.categoryFilter.value = 'all';
            if (el.locationFilter) el.locationFilter.value = '';
            document.querySelectorAll('.service-checkbox:checked').forEach(cb => cb.checked = false);
            applyFilters();
        };

        const applyFilters = () => {
            const query = el.searchQuery.value.toLowerCase();
            const category = el.categoryFilter.value;
            const location = el.locationFilter ? el.locationFilter.value.toLowerCase() : '';
            const selectedServices = Array.from(document.querySelectorAll('.service-checkbox:checked')).map(cb => cb.dataset.servicekey);
            filteredClients = clientsData.filter(c => {
                 const hasAllServices = selectedServices.every(sKey => c[sKey] && c[sKey].toLowerCase() !== 'false' && c[sKey].trim() !== '');
                 const locationMatch = !location || (c.address && c.address.toLowerCase().includes(location));
                 return c.name.toLowerCase().includes(query) && (category === 'all' || c.category === category) && locationMatch && hasAllServices;
            });
            
            const count = [query !== '', category !== 'all', location !== '', selectedServices.length > 0].filter(Boolean).length;
            el.filterCount.textContent = count;
            el.filterCount.classList.toggle('hidden', count === 0);
            el.filterCount.classList.toggle('flex', count > 0);
            
            renderClients();
        };

        const formatNumber = (num) => String(num).replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        
        const showToast = (message) => {
            el.toastMessage.textContent = message;
            el.toast.classList.remove('opacity-0', 'translate-y-4');
            setTimeout(() => {
                el.toast.classList.add('opacity-0', 'translate-y-4');
            }, 3000);
        };
        
        const setupDashboard = () => {
            // Stats
            const createStatCard = (title, value, icon, color) => `
                <div class="bg-white p-5 rounded-2xl shadow-sm flex items-center gap-5">
                    <div class="rounded-full p-3 ${color.bg} ${color.text}">
                        <i data-lucide="${icon}" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-slate-500">${title}</p>
                        <p class="text-2xl font-bold text-slate-900 mt-1">${value}</p>
                    </div>
                </div>
            `;
            const statsGrid = document.getElementById('stats-container');
            statsGrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8';
            statsGrid.innerHTML = 
                createStatCard('Celkem klientů', clientsData.length, 'users', {bg: 'bg-indigo-100', text: 'text-indigo-600'}) +
                createStatCard('Noví klienti', clientsData.filter(c=>c.isNew).length, 'sparkles', {bg: 'bg-green-100', text: 'text-green-600'}) +
                createStatCard('Zobrazení prohlídek', statsData.prohlidky ? formatNumber(statsData.prohlidky) : 'N/A', 'eye', {bg: 'bg-purple-100', text: 'text-purple-600'}) +
                createStatCard('Zobrazení novinek', statsData.novinky ? formatNumber(statsData.novinky) : 'N/A', 'newspaper', {bg: 'bg-sky-100', text: 'text-sky-600'});

            // Recent Clients
            const recentClients = [...clientsData].sort((a, b) => parseInt(b.id) - parseInt(a.id)).slice(0, 5);
            el.recentClientsContainer.innerHTML = recentClients.length > 0 ? recentClients.map(c => `
                <div class="flex items-center p-3 bg-slate-50 hover:bg-slate-100 transition-colors rounded-lg">
                    <div class="flex-1">
                        <p class="font-semibold text-slate-800">${c.name}</p>
                        <p class="text-sm text-slate-500">${c.category}</p>
                    </div>
                    ${c.isNew ? '<span class="text-xs font-medium text-green-700 bg-green-100 px-2 py-1 rounded-full">Nový</span>' : ''}
                </div>
            `).join('') : '<p class="text-slate-500 text-sm">Nebyly nalezeny žádné nedávné klienty.</p>';
            
            // Top Categories Chart
            const categoryCounts = clientsData.reduce((acc, c) => {
                const category = c.category ? c.category.trim() : '';
                if (category && category.toLowerCase() !== 'n/a' && category.toLowerCase() !== 'nenalezeno') {
                    acc[category] = (acc[category] || 0) + 1;
                }
                return acc;
            }, {});
            const sortedCategories = Object.entries(categoryCounts).sort(([,a],[,b]) => b - a).slice(0, 5);

            if(topCategoriesChart) topCategoriesChart.destroy();
            topCategoriesChart = new Chart(document.getElementById('topCategoriesChart'), { 
                type: 'bar', 
                data: { 
                    labels: sortedCategories.map(item => item[0]), 
                    datasets: [{ 
                        label: 'Počet klientů', 
                        data: sortedCategories.map(item => item[1]), 
                        backgroundColor: '#34A853',
                        borderRadius: 5,
                        barThickness: 20
                    }] 
                }, 
                options: { 
                    indexAxis: 'y',
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } },
                    scales: { 
                        y: { grid: { display: false, drawBorder: false } },
                        x: { grid: { display: true, drawBorder: false }, ticks: { stepSize: 1 } } 
                    } 
                } 
            });
            
            el.dashboardContent.classList.add('opacity-100');
        };
        
        const setupEventListeners = () => {
            el.navLinks.forEach(b => b.addEventListener('click', () => {
                el.navLinks.forEach(btn => btn.classList.remove('active'));
                b.classList.add('active');
                Object.values(el.views).forEach(v => v.classList.add('hidden'));
                el.views[b.dataset.view].classList.remove('hidden');
            }));
            
            el.toggleFiltersBtn.addEventListener('click', () => {
                const panel = el.filterPanel;
                if (panel.style.maxHeight && panel.style.maxHeight !== "0px") {
                    panel.style.maxHeight = "0px";
                    panel.style.marginBottom = "0px";
                } else {
                    panel.style.maxHeight = panel.scrollHeight + "px";
                    panel.style.marginBottom = "2rem";
                }
            });
            el.reloadDataBtn.addEventListener('click', async () => {
                el.reloadDataBtn.disabled = true;
                el.reloadDataBtn.querySelector('i').classList.add('animate-spin');
                localStorage.removeItem('clientsData'); // Clear cache on manual refresh
                localStorage.removeItem('statsData');
                await loadAndRenderData(true);
                el.reloadDataBtn.disabled = false;
                el.reloadDataBtn.querySelector('i').classList.remove('animate-spin');
                showToast('Data byla úspěšně aktualizována!');
            });
            el.resetFiltersBtn.addEventListener('click', resetFilters);

            const debouncedFilter = debounce(applyFilters, 300);
            if(el.locationFilter) {
                [el.searchQuery, el.locationFilter].forEach(i => i.addEventListener('input', debouncedFilter));
            } else {
                el.searchQuery.addEventListener('input', debouncedFilter);
            }
            
            [el.categoryFilter, el.servicesFilterContainer].forEach(i => i.addEventListener('change', applyFilters));
        };
        
        const processAndRenderAllData = () => {
            el.skeletonLoader.innerHTML = '';
            if (clientsData && clientsData.length > 0) {
                filteredClients = clientsData;
                
                const filterHTML = Object.entries(servicesMap).map(([key, s]) => `<div class="flex items-center"><input id="${key}" type="checkbox" data-servicekey="${key}" class="service-checkbox h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"><label for="${key}" class="ml-3 text-sm text-slate-600">${s.name}</label></div>`).join('');
                el.servicesFilterContainer.innerHTML = filterHTML;
                const categories = [...new Set(clientsData.map(c => c.category))];
                el.categoryFilter.innerHTML = '<option value="all">Všechny kategorie</option>' + categories.filter(c => c && c.trim() !== '' && c.toLowerCase() !== 'n/a' && c.toLowerCase() !== 'nenalezeno').sort().map(c=>`<option value="${c}">${c}</option>`).join('');
                
                setupDashboard();
                renderClients();
            } else {
                el.clientsContainer.innerHTML = '';
                el.emptyState.innerHTML = `<div class="inline-block bg-white p-5 rounded-full shadow-sm"><i data-lucide="cloud-off" class="w-12 h-12 text-slate-400"></i></div><h3 class="mt-6 text-xl font-semibold">Nebylo možné načíst data</h3><p class="mt-2 text-slate-500">Zkuste prosím obnovit stránku nebo zkontrolovat připojení.</p>`;
                el.emptyState.classList.remove('hidden');
            }
            lucide.createIcons();
        };

        const loadAndRenderData = async (forceRefresh = false) => {
            if (!forceRefresh) {
                const cachedClients = localStorage.getItem('clientsData');
                const cachedStats = localStorage.getItem('statsData');
                if (cachedClients && cachedStats) {
                    console.log("Načítání z mezipaměti (cache)...");
                    clientsData = JSON.parse(cachedClients);
                    statsData = JSON.parse(cachedStats);
                    processAndRenderAllData();
                    // Fetch in background for next time
                    Promise.all([
                        fetchAndParseSheetData(CLIENTS_SHEET_URL, false, true),
                        fetchAndParseSheetData(STATS_SHEET_URL, true, true)
                    ]).then(([clientDataResult, statsDataResult]) => {
                        if (clientDataResult) {
                            localStorage.setItem('clientsData', JSON.stringify(clientDataResult));
                            localStorage.setItem('statsData', JSON.stringify(statsDataResult || {}));
                        }
                    });
                    return;
                }
                el.views.clients.classList.add('hidden');
                el.clientsContainer.innerHTML = `<div class="space-y-3">${Array(8).fill('<div class="bg-white p-4 rounded-xl shadow-sm animate-pulse flex items-center gap-4"><div class="flex-1"><div class="h-5 bg-slate-200 rounded w-1/3 mb-2"></div><div class="h-4 bg-slate-200 rounded w-1/4"></div></div><div class="flex items-center gap-3"><div class="w-6 h-6 bg-slate-200 rounded-full"></div><div class="w-6 h-6 bg-slate-200 rounded-full"></div></div></div>').join('')}</div>`;
            }
            
            try {
                const [clientDataResult, statsDataResult] = await Promise.all([
                    fetchAndParseSheetData(CLIENTS_SHEET_URL, false, true),
                    fetchAndParseSheetData(STATS_SHEET_URL, true, true)
                ]);

                if (clientDataResult) {
                    localStorage.setItem('clientsData', JSON.stringify(clientDataResult));
                    localStorage.setItem('statsData', JSON.stringify(statsDataResult || {}));
                    clientsData = clientDataResult;
                    statsData = statsDataResult;
                    processAndRenderAllData();
                } else {
                    throw new Error("Nepodařilo se zpracovat data klientů.");
                }
            } catch(error) {
                console.error("Fatální chyba při načítání:", error);
                el.clientsContainer.innerHTML = '';
                el.emptyState.innerHTML = `<div class="inline-block bg-red-100 p-5 rounded-full shadow-sm"><i data-lucide="alert-triangle" class="w-12 h-12 text-red-500"></i></div><h3 class="mt-6 text-xl font-semibold">Něco se pokazilo</h3><p class="mt-2 text-slate-500">Aplikaci se nepodařilo načíst. Zkuste prosím obnovit stránku.</p><p class="mt-1 text-xs text-slate-400">Chyba: ${error.message}</p>`;
                el.emptyState.classList.remove('hidden');
                lucide.createIcons();
            }
        };

        // --- INIT ---
        setupEventListeners();
        await loadAndRenderData(false);
    });
    </script>
</body>
</html>

